<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <clear/>
		
        <!-- 1) Każdy URL z kropką (wygląda jak plik) -> jeśli brak w root, ale jest w /app/{R:0}, przepnij tam -->
        <rule name="Map files to app" stopProcessing="true">
          <!-- przykład: main.js, assets/img/logo.png, styles.css, ... -->
          <match url="^(.*\.[^/]+)$" />
          <conditions logicalGrouping="MatchAll">
            <!-- pliku NIE ma w bieżącym katalogu aplikacji -->
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <!-- ale ISTNIEJE w /app/{R:0} -->
            <add input="{APPL_PHYSICAL_PATH}app\{R:0}" matchType="IsFile" />
          </conditions>
          <!-- UWAGA: bez wiodącego / (ścieżka względna do root tej aplikacji: /nb05preprod) -->
          <action type="Rewrite" url="app/{R:0}" appendQueryString="true" />
        </rule>
		
        <!-- 2) Root files -> nb05preprod (rewrite)" -->
		<rule name="Root files -> nb05preprod (rewrite)" stopProcessing="true">
		  <match url="^(?!nb05preprod/)(.*\.[^/]+)$" />
		  <action type="Rewrite" url="/nb05preprod/{R:1}" />
		</rule>

        <!-- 3) Jeśli (po aktualnym URL) faktycznie istnieje plik -> zostaw IIS -->
        <rule name="Serve existing files" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" />
          </conditions>
          <action type="None" />
        </rule>

        <!-- 4) Tylko trasy BEZ kropki (SPA) -> Node (server.js) -->
        <rule name="SPA to Node (no dot)" stopProcessing="true">
          <match url="^(?!.*\.).*$" />
          <action type="Rewrite" url="server.js" appendQueryString="true" />
        </rule>
      </rules>
    </rewrite>

    <handlers>
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
    </handlers>

    <iisnode
      watchedFiles="web.config;*.js"
      nodeProcessCommandLine="%programfiles%\nodejs\node.exe"
      loggingEnabled="false"
      devErrorsEnabled="false" />
  </system.webServer>
</configuration>
